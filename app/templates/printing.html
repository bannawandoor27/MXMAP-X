{% extends "base.html" %}

{% block title %}Printing Design - MXMAP-X{% endblock %}

{% block content %}
<div x-data="printingApp()" x-init="init()" class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Printing/Process-Aware Design</h1>
        <p class="text-gray-600">Ink formulation, Rs-T trade-off, and manufacturability optimization</p>
    </div>

    <!-- Manufacturability Score Badge -->
    <div x-show="results" class="mb-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold mb-2">Manufacturability Score</h2>
                    <div class="flex items-center space-x-4">
                        <div class="text-5xl font-bold" 
                             :class="{
                                 'text-green-600': results?.manufacturability_score >= 80,
                                 'text-yellow-600': results?.manufacturability_score >= 60 && results?.manufacturability_score < 80,
                                 'text-orange-600': results?.manufacturability_score >= 40 && results?.manufacturability_score < 60,
                                 'text-red-600': results?.manufacturability_score < 40
                             }"
                             x-text="results?.manufacturability_score"></div>
                        <div class="text-sm text-gray-600">
                            <div>Printability • Risk • Throughput</div>
                            <div>Post-treatment • Yield</div>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-600 mb-2">Haacke FoM</div>
                    <div class="text-2xl font-bold text-purple-600" x-text="results?.printed_film?.haacke_FoM?.toExponential(2)"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Panel: Inputs -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Configuration</h2>

                <!-- Process Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Printing Process</label>
                    <select x-model="process" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="gravure">Gravure</option>
                        <option value="screen">Screen Printing</option>
                        <option value="inkjet">Inkjet</option>
                        <option value="slot-die">Slot-Die</option>
                        <option value="doctor-blade">Doctor Blade</option>
                    </select>
                </div>

                <!-- Material -->
                <h3 class="font-semibold mb-3">Material</h3>
                <div class="space-y-3 mb-6">
                    <div>
                        <label class="block text-sm text-gray-600">MXene Type</label>
                        <select x-model="mxeneType" class="w-full px-3 py-2 border rounded-md">
                            <option value="Ti3C2Tx">Ti₃C₂Tₓ</option>
                            <option value="Mo2CTx">Mo₂CTₓ</option>
                            <option value="V2CTx">V₂CTₓ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Flake Size (μm)</label>
                        <input type="number" x-model.number="flakeSize" class="w-full px-3 py-2 border rounded-md" min="0.1" max="20" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Substrate</label>
                        <select x-model="substrate" class="w-full px-3 py-2 border rounded-md">
                            <option value="PET">PET</option>
                            <option value="PI">Polyimide</option>
                            <option value="glass">Glass</option>
                            <option value="paper">Paper</option>
                        </select>
                    </div>
                </div>

                <!-- Targets -->
                <h3 class="font-semibold mb-3">Targets</h3>
                <div class="space-y-3 mb-6">
                    <div>
                        <label class="block text-sm text-gray-600">Thickness (nm)</label>
                        <input type="number" x-model.number="targetThickness" class="w-full px-3 py-2 border rounded-md" min="50" max="2000" step="10">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Transmittance @ 550nm</label>
                        <input type="number" x-model.number="targetTransmittance" class="w-full px-3 py-2 border rounded-md" min="0.1" max="1.0" step="0.01">
                    </div>
                </div>

                <!-- Post-Treatment -->
                <h3 class="font-semibold mb-3">Post-Treatment</h3>
                <div class="space-y-3 mb-6">
                    <div>
                        <label class="block text-sm text-gray-600">Anneal Temp (°C)</label>
                        <input type="number" x-model.number="annealTemp" class="w-full px-3 py-2 border rounded-md" min="80" max="300" step="10">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Anneal Time (min)</label>
                        <input type="number" x-model.number="annealTime" class="w-full px-3 py-2 border rounded-md" min="5" max="180" step="5">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Press (MPa)</label>
                        <input type="number" x-model.number="pressMPa" class="w-full px-3 py-2 border rounded-md" min="0" max="50" step="1">
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-3">
                    <button @click="recommend()" :disabled="loading" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50">
                        <span x-show="!loading">Get Recommendations</span>
                        <span x-show="loading">Computing...</span>
                    </button>
                    <button @click="exportRecipe()" :disabled="!results" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50">
                        Export Recipe Card
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel: Results -->
        <div class="lg:col-span-2">
            <div class="space-y-6">
                <!-- Ink Window -->
                <div x-show="results" class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Ink Formulation Window</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded">
                            <div class="text-sm text-gray-600">Solids (wt%)</div>
                            <div class="text-lg font-bold text-blue-600" x-text="results?.ink_window?.solids_wt_pct?.join(' - ')"></div>
                        </div>
                        <div class="bg-green-50 p-4 rounded">
                            <div class="text-sm text-gray-600">Viscosity (mPa·s)</div>
                            <div class="text-lg font-bold text-green-600" x-text="results?.ink_window?.viscosity_mPas?.map(v => v.toFixed(0)).join(' - ')"></div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded">
                            <div class="text-sm text-gray-600">Surface Tension (mN/m)</div>
                            <div class="text-lg font-bold text-purple-600" x-text="results?.ink_window?.surface_tension_mNpm?.join(' - ')"></div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded">
                            <div class="text-sm text-gray-600">Flake d₅₀ (μm)</div>
                            <div class="text-lg font-bold text-orange-600" x-text="results?.ink_window?.flake_distribution_um?.d50?.toFixed(1)"></div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm text-gray-600 mb-2">Recommended Additives:</div>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="additive in results?.ink_window?.additives" :key="additive">
                                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm" x-text="additive"></span>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Rs-T Trade-off -->
                <div x-show="results" class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Rs-T Trade-off</h2>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-red-50 p-4 rounded">
                            <div class="text-sm text-gray-600">Sheet Resistance</div>
                            <div class="text-2xl font-bold text-red-600" x-text="results?.printed_film?.sheet_res_ohm_sq?.toFixed(1) + ' Ω/sq'"></div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded">
                            <div class="text-sm text-gray-600">Transmittance</div>
                            <div class="text-2xl font-bold text-blue-600" x-text="(results?.printed_film?.transmittance_550nm * 100)?.toFixed(1) + '%'"></div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded">
                            <div class="text-sm text-gray-600">Post-Treatment ΔRs</div>
                            <div class="text-2xl font-bold text-purple-600" x-text="results?.post_treatment_effect?.delta_rs_pct?.toFixed(1) + '%'"></div>
                        </div>
                    </div>
                    <div id="rsTPlot" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script>
function printingApp() {
    return {
        loading: false,
        process: 'screen',
        mxeneType: 'Ti3C2Tx',
        flakeSize: 2.0,
        substrate: 'PET',
        targetThickness: 200,
        targetTransmittance: 0.85,
        annealTemp: 120,
        annealTime: 30,
        pressMPa: 10,
        results: null,

        init() {
            console.log('Printing app initialized');
        },

        async recommend() {
            this.loading = true;
            try {
                const response = await fetch('/api/v1/printing/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        process: this.process,
                        mxene_type: this.mxeneType,
                        flake_size_um: this.flakeSize,
                        target_thickness_nm: this.targetThickness,
                        target_transmittance_550nm: this.targetTransmittance,
                        substrate: this.substrate,
                        environment: { temp_C: 25, rh_pct: 45 },
                        post_treatment: {
                            anneal_C: this.annealTemp,
                            anneal_min: this.annealTime,
                            press_MPa: this.pressMPa
                        }
                    })
                });
                
                if (!response.ok) throw new Error('Recommendation failed');
                
                this.results = await response.json();
                this.plotRsT();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        plotRsT() {
            if (!this.results) return;
            
            const trace = {
                x: this.results.printed_film.rs_t_curve.T_550nm.map(t => t * 100),
                y: this.results.printed_film.rs_t_curve.rs_ohm_sq,
                type: 'scatter',
                mode: 'lines+markers',
                marker: { size: 8, color: 'blue' },
                line: { color: 'blue', width: 2 },
                name: 'Rs-T Trade-off'
            };
            
            // Add current point
            const current = {
                x: [this.results.printed_film.transmittance_550nm * 100],
                y: [this.results.printed_film.sheet_res_ohm_sq],
                type: 'scatter',
                mode: 'markers',
                marker: { size: 15, color: 'red', symbol: 'star' },
                name: 'Current Design'
            };
            
            const layout = {
                xaxis: { title: 'Transmittance @ 550nm (%)' },
                yaxis: { type: 'log', title: 'Sheet Resistance (Ω/sq)' },
                showlegend: true,
                hovermode: 'closest'
            };
            
            Plotly.newPlot('rsTPlot', [trace, current], layout, { responsive: true });
        },

        exportRecipe() {
            if (!this.results) return;
            const recipe = {
                process: this.process,
                ink_window: this.results.ink_window,
                printed_film: this.results.printed_film,
                post_treatment: this.results.post_treatment_effect,
                manufacturability_score: this.results.manufacturability_score
            };
            const blob = new Blob([JSON.stringify(recipe, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'printing_recipe.json';
            a.click();
        }
    };
}
</script>
{% endblock %}
